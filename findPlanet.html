<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>مهمة الفضاء: إنقاذ كوكب نوميروس</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Cairo:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Cairo", sans-serif;
        background-color: #0c0a1a;
        color: #e0e0e0;
        margin: 0;
        overflow-x: hidden;
      }

      #space-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        pointer-events: none;
      }

      .mission-control {
        width: 100%;
        max-width: 800px;
        margin: 2rem auto;
        background: rgba(18, 16, 41, 0.9);
        backdrop-filter: blur(15px);
        border-radius: 1.5rem;
        box-shadow: 0 0 40px rgba(76, 29, 149, 0.7);
        padding: 2rem;
        border: 2px solid rgba(139, 92, 246, 0.6);
        position: relative;
        z-index: 10;
      }

      /* إضافة أنماط نموذج الاسم */
      .name-form {
        background: linear-gradient(
          135deg,
          rgba(30, 27, 75, 0.9),
          rgba(45, 35, 95, 0.7)
        );
        border: 2px solid rgba(251, 191, 36, 0.6);
        border-radius: 1.5rem;
        padding: 2rem;
        text-align: center;
        box-shadow: 0 0 30px rgba(251, 191, 36, 0.4);
        margin-bottom: 2rem;
      }

      .name-input {
        background: linear-gradient(135deg, #1e1b4b, #2d1b69);
        border: 2px solid #fbbf24;
        color: #f5f3ff;
        border-radius: 0.75rem;
        width: 300px;
        height: 3rem;
        font-size: 1.25rem;
        text-align: center;
        transition: all 0.3s ease;
        font-family: "Cairo", sans-serif;
      }

      .name-input:focus {
        border-color: #fb923c;
        box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        outline: none;
      }

      .start-btn {
        background: linear-gradient(135deg, #fbbf24, #fb923c);
        color: #1a1a1a;
        font-weight: bold;
        padding: 0.75rem 2rem;
        border-radius: 2rem;
        margin-top: 1rem;
        border: none;
        border-bottom: 4px solid #f59e0b;
        transition: all 0.3s ease;
        font-family: "Orbitron", sans-serif;
        font-size: 1rem;
        cursor: pointer;
        overflow: hidden;
        position: relative;
      }

      .start-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(251, 191, 36, 0.4);
      }

      /* إضافة أنماط الشهادة */
      .certificate {
        background: linear-gradient(135deg, #ffffff, #f8f9fa);
        color: #333;
        border-radius: 1.5rem;
        padding: 3rem;
        text-align: center;
        border: 8px solid #ffd700;
        box-shadow: 0 0 40px rgba(255, 215, 0, 0.6);
        position: relative;
        overflow: hidden;
        margin-top: 2rem;
      }

      .certificate::before {
        content: "";
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        bottom: 20px;
        border: 3px solid #ffd700;
        border-radius: 1rem;
        pointer-events: none;
      }

      .certificate-title {
        font-family: "Orbitron", sans-serif;
        font-size: 2.5rem;
        color: #8b5cf6;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        margin-bottom: 1rem;
      }

      .certificate-subtitle {
        font-size: 1.5rem;
        color: #6b46c1;
        margin-bottom: 2rem;
      }

      .certificate-name {
        font-family: "Orbitron", sans-serif;
        font-size: 3rem;
        color: #dc2626;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        margin: 2rem 0;
        padding: 1rem;
        border-bottom: 3px solid #ffd700;
        border-top: 3px solid #ffd700;
      }

      .certificate-text {
        font-size: 1.25rem;
        color: #374151;
        margin: 1.5rem 0;
        line-height: 1.8;
      }

      .certificate-date {
        font-size: 1rem;
        color: #6b7280;
        margin-top: 2rem;
      }

      .download-btn {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        font-weight: bold;
        padding: 0.75rem 2rem;
        border-radius: 2rem;
        margin-top: 1.5rem;
        border: none;
        border-bottom: 4px solid #047857;
        transition: all 0.3s ease;
        font-family: "Orbitron", sans-serif;
        font-size: 1rem;
        cursor: pointer;
      }

      .download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
      }

      .checkpoint {
        background: linear-gradient(
          135deg,
          rgba(30, 27, 75, 0.8),
          rgba(45, 35, 95, 0.6)
        );
        border: 2px solid rgba(139, 92, 246, 0.4);
        padding: 1.5rem;
        border-radius: 1.25rem;
        text-align: center;
        margin-top: 1.5rem;
        transition: all 0.5s ease;
        opacity: 0;
        transform: translateY(20px);
        position: relative;
        overflow: hidden;
      }

      .checkpoint::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
          45deg,
          transparent,
          rgba(139, 92, 246, 0.1),
          transparent
        );
        transform: rotate(45deg);
        animation: shimmer 3s infinite;
      }

      @keyframes shimmer {
        0%,
        100% {
          transform: translateX(-100%) translateY(-100%) rotate(45deg);
        }
        50% {
          transform: translateX(100%) translateY(100%) rotate(45deg);
        }
      }

      .checkpoint.unlocked {
        opacity: 1;
        transform: translateY(0);
      }

      .checkpoint.active {
        border-color: #fbbf24;
        box-shadow: 0 0 30px rgba(251, 191, 36, 0.6);
        animation: pulse-glow 2s infinite;
      }

      @keyframes pulse-glow {
        0%,
        100% {
          box-shadow: 0 0 30px rgba(251, 191, 36, 0.6);
        }
        50% {
          box-shadow: 0 0 50px rgba(251, 191, 36, 0.9);
        }
      }

      .checkpoint h3 {
        font-family: "Orbitron", sans-serif;
        font-size: 1.75rem;
        font-weight: 700;
        color: #a78bfa;
        margin-bottom: 1rem;
        text-shadow: 0 0 15px #a78bfa;
        position: relative;
        z-index: 2;
      }

      .path {
        text-align: center;
        font-size: 3rem;
        opacity: 0;
        transition: opacity 0.5s ease 0.3s;
        height: 60px;
        animation: float 3s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .path.unlocked {
        opacity: 0.8;
      }

      input[type="number"] {
        -moz-appearance: textfield;
        background: linear-gradient(135deg, #1e1b4b, #2d1b69);
        border: 2px solid #6d28d9;
        color: #f5f3ff;
        border-radius: 0.75rem;
        width: 8rem;
        height: 3rem;
        font-size: 1.25rem;
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        z-index: 2;
      }

      input[type="number"]:focus {
        border-color: #fbbf24;
        box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        outline: none;
      }

      .check-btn {
        background: linear-gradient(135deg, #7c3aed, #5b21b6);
        color: white;
        font-weight: bold;
        padding: 0.75rem 2rem;
        border-radius: 2rem;
        margin-top: 1rem;
        border: none;
        border-bottom: 4px solid #5b21b6;
        transition: all 0.3s ease;
        font-family: "Orbitron", sans-serif;
        font-size: 1rem;
        cursor: pointer;
        position: relative;
        z-index: 2;
        overflow: hidden;
      }

      .check-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .check-btn:hover::before {
        left: 100%;
      }

      .check-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(124, 58, 237, 0.4);
      }

      .check-btn:disabled {
        background: linear-gradient(135deg, #4a4a6a, #35354b);
        border-bottom-color: #35354b;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .progress-bar-container {
        width: 100%;
        background: linear-gradient(135deg, #1e1b4b, #2d1b69);
        border-radius: 9999px;
        overflow: hidden;
        border: 2px solid #6d28d9;
        position: relative;
      }

      .progress-bar {
        width: 0%;
        height: 30px;
        background: linear-gradient(90deg, #facc15, #fb923c, #f97316, #dc2626);
        box-shadow: 0 0 20px #f59e0b;
        border-radius: 9999px;
        transition: width 0.8s ease-in-out;
        text-align: center;
        color: #1a1a1a;
        font-weight: bold;
        font-family: "Orbitron", sans-serif;
        line-height: 30px;
        position: relative;
        overflow: hidden;
      }

      .progress-bar::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        animation: progress-shine 2s infinite;
      }

      @keyframes progress-shine {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      .hidden {
        display: none;
      }

      .particle-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
      }

      .title-glow {
        animation: title-pulse 3s ease-in-out infinite;
      }

      @keyframes title-pulse {
        0%,
        100% {
          text-shadow: 0 0 20px #fbbf24, 0 0 40px #fbbf24;
        }
        50% {
          text-shadow: 0 0 30px #fbbf24, 0 0 60px #fbbf24, 0 0 80px #fb923c;
        }
      }
    </style>
  </head>
  <body class="text-gray-200">
    <canvas id="space-canvas"></canvas>

    <div class="mission-control">
      <canvas class="particle-canvas" id="particle-canvas"></canvas>

      <!-- نموذج إدخال الاسم - جديد -->
      <div id="name-form" class="name-form">
        <h2
          style="font-family: 'Orbitron', sans-serif"
          class="text-3xl font-bold text-[#FBBF24] mb-4"
        >
          مرحباً أيها المستكشف الشجاع!
        </h2>
        <p class="text-lg text-[#D8B4FE] mb-6">
          قبل أن نبدأ مهمة إنقاذ كوكب نوميروس، أخبرنا ما اسمك؟
        </p>
        <div class="flex flex-col items-center gap-4">
          <input
            type="text"
            id="student-name"
            class="name-input"
            placeholder="اكتب اسمك هنا..."
            maxlength="30"
          />
          <button id="start-mission" class="start-btn">ابدأ المهمة! 🚀</button>
        </div>
      </div>

      <!-- المحتوى الأساسي للمهمة -->
      <div id="mission-content" class="hidden">
        <!-- Header -->
        <div class="text-center mb-6">
          <h1
            style="font-family: 'Orbitron', sans-serif"
            class="text-4xl md:text-5xl font-bold text-[#FBBF24] title-glow"
          >
            MISSION: FIND PLANET NUMEROS
          </h1>
          <p class="text-lg text-[#D8B4FE] mt-2">
            اشحن طاقة مركبتك لإكمال المهمة!
          </p>
          <p id="pilot-name" class="text-xl text-[#FBBF24] mt-2 font-bold"></p>
        </div>

        <!-- Progress Bar (Fuel Level) -->
        <div class="progress-bar-container mb-6">
          <div id="progress-bar" class="progress-bar">FUEL: 0%</div>
        </div>

        <!-- The checkpoints will be dynamically unlocked -->
        <div id="mission-path"></div>

        <!-- Final Congratulations Message -->
        <div
          id="final-congrats"
          class="hidden text-center mt-8 p-8 bg-gradient-to-br from-purple-800 via-indigo-900 to-blue-800 rounded-2xl border-4 border-yellow-400 relative overflow-hidden"
        >
          <canvas class="particle-canvas" id="celebration-canvas"></canvas>
          <h2
            style="font-family: 'Orbitron', sans-serif"
            class="text-4xl font-bold text-yellow-300 relative z-10"
          >
            MISSION ACCOMPLISHED
          </h2>
          <p class="text-2xl text-white mt-4 relative z-10">
            لقد وصلت إلى كوكب نوميروس!
          </p>
          <p class="text-7xl mt-4 animate-pulse relative z-10">🪐</p>
          <p class="text-xl text-yellow-200 font-bold relative z-10">
            أنت أعظم مستكشف في المجرة!
          </p>
          <button id="get-certificate" class="download-btn mt-4 relative z-10">
            احصل على شهادة التقدير! 🏆
          </button>
        </div>

        <!-- شهادة التقدير - جديدة -->
        <div id="certificate" class="certificate hidden">
          <div class="text-8xl mb-4">🏆</div>
          <h1 class="certificate-title">شهادة تقدير</h1>
          <p class="certificate-subtitle">مهمة الفضاء: إنقاذ كوكب نوميروس</p>

          <div class="my-8">
            <p class="certificate-text">هذه الشهادة تُمنح للطالب المتميز</p>
            <div id="certificate-name" class="certificate-name"></div>
            <p class="certificate-text">
              لإتمامه بنجاح مهمة إنقاذ كوكب نوميروس
            </p>
            <p class="certificate-text">
              وإظهاره مهارات رائعة في الرياضيات والمنطق
            </p>
          </div>

          <div class="flex justify-center items-center gap-8 mt-8">
            <div class="text-6xl">🚀</div>
            <div class="text-6xl">🪐</div>
            <div class="text-6xl">⭐</div>
          </div>

          <p class="certificate-date" id="certificate-date"></p>

          <div class="mt-6">
            <button id="download-certificate" class="download-btn">
              تحميل الشهادة 📥
            </button>
            <button id="restart-mission" class="start-btn mr-4">
              مهمة جديدة 🔄
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Enhanced Space Background Animation
      class SpaceAnimation {
        constructor() {
          this.canvas = document.getElementById("space-canvas");
          if (!this.canvas) return;

          this.ctx = this.canvas.getContext("2d");
          this.stars = [];
          this.nebula = [];
          this.planets = [];
          this.comets = [];

          this.resize();
          this.createStars();
          this.createNebula();
          this.createPlanets();
          this.createComets();
          this.animate();

          window.addEventListener("resize", () => this.resize());
        }

        resize() {
          this.canvas.width = window.innerWidth;
          this.canvas.height = window.innerHeight;
        }

        createStars() {
          for (let i = 0; i < 200; i++) {
            this.stars.push({
              x: Math.random() * this.canvas.width,
              y: Math.random() * this.canvas.height,
              size: Math.random() * 2 + 0.5,
              brightness: Math.random(),
              twinkleSpeed: Math.random() * 0.02 + 0.01,
            });
          }
        }

        createNebula() {
          for (let i = 0; i < 50; i++) {
            this.nebula.push({
              x: Math.random() * this.canvas.width,
              y: Math.random() * this.canvas.height,
              size: Math.random() * 100 + 50,
              color: `hsl(${Math.random() * 60 + 240}, 70%, 20%)`,
              drift: Math.random() * 0.5 + 0.1,
            });
          }
        }

        createPlanets() {
          for (let i = 0; i < 3; i++) {
            this.planets.push({
              x: Math.random() * this.canvas.width,
              y: Math.random() * this.canvas.height,
              size: Math.random() * 30 + 20,
              color: `hsl(${Math.random() * 360}, 60%, 50%)`,
              rotation: 0,
              rotationSpeed: Math.random() * 0.01 + 0.005,
            });
          }
        }

        createComets() {
          for (let i = 0; i < 5; i++) {
            this.comets.push({
              x: -50,
              y: Math.random() * this.canvas.height,
              speed: Math.random() * 2 + 1,
              size: Math.random() * 3 + 2,
              tail: [],
            });
          }
        }

        animate() {
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

          // Draw nebula
          this.nebula.forEach((n) => {
            this.ctx.globalAlpha = 0.3;
            this.ctx.fillStyle = n.color;
            this.ctx.beginPath();
            this.ctx.arc(n.x, n.y, n.size, 0, Math.PI * 2);
            this.ctx.fill();
            n.x += n.drift;
            if (n.x > this.canvas.width + 100) n.x = -100;
          });

          // Draw stars with twinkling
          this.ctx.globalAlpha = 1;
          this.stars.forEach((star) => {
            star.brightness += star.twinkleSpeed;
            if (star.brightness > 1 || star.brightness < 0) {
              star.twinkleSpeed *= -1;
            }

            this.ctx.globalAlpha = Math.abs(star.brightness);
            this.ctx.fillStyle = "#ffffff";
            this.ctx.beginPath();
            this.ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
            this.ctx.fill();
          });

          // Draw planets
          this.ctx.globalAlpha = 0.8;
          this.planets.forEach((planet) => {
            planet.rotation += planet.rotationSpeed;

            this.ctx.save();
            this.ctx.translate(planet.x, planet.y);
            this.ctx.rotate(planet.rotation);

            // Planet body
            this.ctx.fillStyle = planet.color;
            this.ctx.beginPath();
            this.ctx.arc(0, 0, planet.size, 0, Math.PI * 2);
            this.ctx.fill();

            // Planet rings
            this.ctx.strokeStyle = `${planet.color}88`;
            this.ctx.lineWidth = 2;
            this.ctx.beginPath();
            this.ctx.ellipse(
              0,
              0,
              planet.size * 1.5,
              planet.size * 0.3,
              0,
              0,
              Math.PI * 2
            );
            this.ctx.stroke();

            this.ctx.restore();
          });

          // Draw comets
          this.ctx.globalAlpha = 1;
          this.comets.forEach((comet) => {
            // Update comet position
            comet.x += comet.speed;
            comet.y += Math.sin(comet.x * 0.01) * 0.5;

            // Add to tail
            comet.tail.push({ x: comet.x, y: comet.y });
            if (comet.tail.length > 20) {
              comet.tail.shift();
            }

            // Draw tail
            for (let i = 0; i < comet.tail.length; i++) {
              const alpha = i / comet.tail.length;
              this.ctx.globalAlpha = alpha;
              this.ctx.fillStyle = "#00ffff";
              this.ctx.beginPath();
              this.ctx.arc(
                comet.tail[i].x,
                comet.tail[i].y,
                comet.size * alpha,
                0,
                Math.PI * 2
              );
              this.ctx.fill();
            }

            // Draw comet head
            this.ctx.globalAlpha = 1;
            this.ctx.fillStyle = "#ffffff";
            this.ctx.beginPath();
            this.ctx.arc(comet.x, comet.y, comet.size, 0, Math.PI * 2);
            this.ctx.fill();

            // Reset comet if off screen
            if (comet.x > this.canvas.width + 50) {
              comet.x = -50;
              comet.y = Math.random() * this.canvas.height;
              comet.tail = [];
            }
          });

          requestAnimationFrame(() => this.animate());
        }
      }

      // Particle System for UI Elements
      class ParticleSystem {
        constructor(canvas) {
          this.canvas = canvas;
          if (!this.canvas) return;

          this.ctx = canvas.getContext("2d");
          this.particles = [];
          this.resize();
          this.animate();
        }

        resize() {
          this.canvas.width = this.canvas.offsetWidth;
          this.canvas.height = this.canvas.offsetHeight;
        }

        addParticles(x, y, color = "#A78BFA", count = 10) {
          for (let i = 0; i < count; i++) {
            this.particles.push({
              x: x + (Math.random() - 0.5) * 50,
              y: y + (Math.random() - 0.5) * 50,
              vx: (Math.random() - 0.5) * 4,
              vy: (Math.random() - 0.5) * 4,
              size: Math.random() * 4 + 2,
              color: color,
              life: 1.0,
              decay: Math.random() * 0.02 + 0.01,
            });
          }
        }

        animate() {
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

          for (let i = this.particles.length - 1; i >= 0; i--) {
            const p = this.particles[i];

            p.x += p.vx;
            p.y += p.vy;
            p.life -= p.decay;
            p.vy += 0.1; // gravity

            if (p.life <= 0) {
              this.particles.splice(i, 1);
              continue;
            }

            this.ctx.globalAlpha = p.life;
            this.ctx.fillStyle = p.color;
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
            this.ctx.fill();
          }

          requestAnimationFrame(() => this.animate());
        }
      }

      // Celebration Particles
      class CelebrationParticles {
        constructor(canvas) {
          this.canvas = canvas;
          if (!this.canvas) return;

          this.ctx = canvas.getContext("2d");
          this.particles = [];
          this.fireworks = [];
          this.intervals = [];
          this.resize();
          this.animate();
          this.startCelebration();
        }

        resize() {
          this.canvas.width = this.canvas.offsetWidth;
          this.canvas.height = this.canvas.offsetHeight;
        }

        startCelebration() {
          // Create continuous fireworks
          const fireworkInterval = setInterval(() => {
            this.createFirework();
          }, 800);

          // Create falling stars
          const starInterval = setInterval(() => {
            this.createFallingStar();
          }, 300);

          this.intervals.push(fireworkInterval, starInterval);
        }

        createFirework() {
          const x = Math.random() * this.canvas.width;
          const y = Math.random() * this.canvas.height * 0.6;
          const colors = [
            "#FFD700",
            "#FF6B6B",
            "#4ECDC4",
            "#45B7D1",
            "#96CEB4",
            "#FFEAA7",
          ];

          for (let i = 0; i < 20; i++) {
            const angle = (Math.PI * 2 * i) / 20;
            const velocity = Math.random() * 4 + 2;

            this.particles.push({
              x: x,
              y: y,
              vx: Math.cos(angle) * velocity,
              vy: Math.sin(angle) * velocity,
              size: Math.random() * 3 + 2,
              color: colors[Math.floor(Math.random() * colors.length)],
              life: 1.0,
              decay: 0.015,
            });
          }
        }

        createFallingStar() {
          this.particles.push({
            x: Math.random() * this.canvas.width,
            y: -10,
            vx: (Math.random() - 0.5) * 2,
            vy: Math.random() * 3 + 2,
            size: Math.random() * 4 + 3,
            color: "#FFFFFF",
            life: 1.0,
            decay: 0.005,
            type: "star",
          });
        }

        animate() {
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

          for (let i = this.particles.length - 1; i >= 0; i--) {
            const p = this.particles[i];

            p.x += p.vx;
            p.y += p.vy;
            p.life -= p.decay;

            if (p.type !== "star") {
              p.vy += 0.05; // gravity for fireworks
            }

            if (p.life <= 0 || p.y > this.canvas.height + 10) {
              this.particles.splice(i, 1);
              continue;
            }

            this.ctx.globalAlpha = p.life;
            this.ctx.fillStyle = p.color;

            if (p.type === "star") {
              // Draw star shape
              this.ctx.save();
              this.ctx.translate(p.x, p.y);
              this.ctx.beginPath();
              for (let j = 0; j < 5; j++) {
                const angle1 = (j * Math.PI * 2) / 5;
                const angle2 = ((j + 0.5) * Math.PI * 2) / 5;
                const r1 = p.size;
                const r2 = p.size * 0.5;

                if (j === 0) {
                  this.ctx.moveTo(Math.cos(angle1) * r1, Math.sin(angle1) * r1);
                } else {
                  this.ctx.lineTo(Math.cos(angle1) * r1, Math.sin(angle1) * r1);
                }
                this.ctx.lineTo(Math.cos(angle2) * r2, Math.sin(angle2) * r2);
              }
              this.ctx.closePath();
              this.ctx.fill();
              this.ctx.restore();
            } else {
              this.ctx.beginPath();
              this.ctx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
              this.ctx.fill();
            }
          }

          requestAnimationFrame(() => this.animate());
        }

        destroy() {
          this.intervals.forEach((interval) => clearInterval(interval));
          this.intervals = [];
        }
      }

      // Game state
      let gameState = {
        playerName: "",
        spaceAnimation: null,
        particleSystem: null,
        celebrationParticles: null,
        checkpointsCompleted: 0,
        checkpointElements: [],
      };

      // Mission data
      const missionData = [
        {
          type: "checkpoint",
          answer: 25,
          title: "🌍 نقطة الإقلاع من الأرض",
          question: "17 + 8 =",
          prompt: "يجب حل هذه المعادلة لتفعيل محركات الإقلاع!",
          button: "إقلاع!",
          feedback: {
            correct: "تم تفعيل المحركات! انطلاق!",
            incorrect: "طاقة غير كافية للإقلاع!",
          },
        },
        { type: "path", icon: "🚀" },
        {
          type: "checkpoint",
          answer: 34,
          title: "🛰️ حقل الكويكبات",
          question: "25 + 9 =",
          prompt: "احسب المسار الصحيح لتجنب الكويكبات.",
          button: "توجيه!",
          feedback: {
            correct: "تم تفادي الخطر بنجاح!",
            incorrect: "مسار خاطئ! حاول مرة أخرى!",
          },
        },
        { type: "path", icon: "✨" },
        {
          type: "checkpoint",
          answer: 21,
          title: "🌌 سديم الألوان",
          question: "15 + 6 =",
          prompt: "اجمع طاقة النجوم الملونة.",
          button: "اجمع!",
          feedback: {
            correct: "طاقة مجمعة!",
            incorrect: "هذه ليست الطاقة المطلوبة.",
          },
        },
        { type: "path", icon: "💫" },
        {
          type: "checkpoint",
          answer: 72,
          title: "🪐 الاقتراب من نوميروس",
          question: "64 + 8 =",
          prompt: "الحساب الأخير للدخول في مدار الكوكب.",
          button: "دخول المدار!",
          feedback: {
            correct: "تم تثبيت المدار! تستعد للهبوط!",
            incorrect: "حسابات خاطئة! انحراف عن المسار!",
          },
        },
      ];

      // Initialize game when DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        initializeGame();
      });

      function initializeGame() {
        // Initialize animations
        gameState.spaceAnimation = new SpaceAnimation();

        const particleCanvas = document.getElementById("particle-canvas");
        if (particleCanvas) {
          gameState.particleSystem = new ParticleSystem(particleCanvas);
        }

        // Set up name form
        setupNameForm();

        // Set up mission
        setupMission();

        // Set up certificate
        setupCertificate();

        // Add resize handler
        window.addEventListener("resize", () => {
          if (gameState.particleSystem) {
            gameState.particleSystem.resize();
          }
        });
      }

      function setupNameForm() {
        const startButton = document.getElementById("start-mission");
        const nameInput = document.getElementById("student-name");
        const nameForm = document.getElementById("name-form");
        const missionContent = document.getElementById("mission-content");

        if (startButton && nameInput && nameForm && missionContent) {
          startButton.addEventListener("click", function () {
            const name = nameInput.value.trim();
            if (name) {
              gameState.playerName = name;
              nameForm.classList.add("hidden");
              missionContent.classList.remove("hidden");

              // Update pilot name display
              const pilotNameElement = document.getElementById("pilot-name");
              if (pilotNameElement) {
                pilotNameElement.textContent = `الطيار: ${name}`;
              }

              // Start the mission
              startMission();
            } else {
              alert("يرجى إدخال اسمك أولاً!");
            }
          });

          nameInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              startButton.click();
            }
          });
        }
      }

      function setupMission() {
        const missionPathContainer = document.getElementById("mission-path");
        if (!missionPathContainer) return;

        const totalCheckpoints = missionData.filter(
          (item) => item.type === "checkpoint"
        ).length;

        // Build the mission dynamically
        missionData.forEach((item, index) => {
          const element = document.createElement("div");

          if (item.type === "checkpoint") {
            element.className = "checkpoint";
            let promptHTML = item.prompt
              ? `<p class="mb-4 text-purple-300">${item.prompt}</p>`
              : "";

            element.innerHTML = `
        <h3>${item.title}</h3>
        ${promptHTML}
        <div class="flex justify-center items-center gap-4 mb-4">
          <p class="text-3xl font-bold text-yellow-300">${item.question}</p>
          <input type="number" class="answer-input p-3 text-center" placeholder="؟">
        </div>
        <button class="check-btn">${item.button}</button>
        <div class="feedback-correct hidden mt-4 p-4 bg-green-900 bg-opacity-60 rounded-xl text-green-300 font-bold border border-green-500">
          <p>${item.feedback.correct}</p>
        </div>
        <div class="feedback-incorrect hidden mt-4 p-4 bg-red-900 bg-opacity-60 rounded-xl text-red-300 font-bold border border-red-500">
          <p>${item.feedback.incorrect}</p>
        </div>
      `;

            const checkBtn = element.querySelector(".check-btn");
            const answerInput = element.querySelector(".answer-input");

            if (checkBtn && answerInput) {
              checkBtn.addEventListener("click", () =>
                checkAnswer(index, item, element, totalCheckpoints)
              );
              answerInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter")
                  checkAnswer(index, item, element, totalCheckpoints);
              });
            }

            // Add hover effects for particles
            element.addEventListener("mouseenter", () => {
              if (
                element.classList.contains("active") &&
                gameState.particleSystem
              ) {
                const rect = element.getBoundingClientRect();
                const containerRect = document
                  .getElementById("particle-canvas")
                  .getBoundingClientRect();
                gameState.particleSystem.addParticles(
                  rect.left + rect.width / 2 - containerRect.left,
                  rect.top + rect.height / 2 - containerRect.top,
                  "#A78BFA",
                  5
                );
              }
            });
          } else {
            // It's a path
            element.className = "path";
            element.innerHTML = item.icon;
          }

          missionPathContainer.appendChild(element);
          gameState.checkpointElements.push(element);
        });
      }

      function startMission() {
        // Start the mission by unlocking the first checkpoint
        if (gameState.checkpointElements[0]) {
          gameState.checkpointElements[0].classList.add("unlocked", "active");
        }

        // Add some ambient particles on load
        setTimeout(() => {
          if (gameState.particleSystem) {
            for (let i = 0; i < 3; i++) {
              setTimeout(() => {
                gameState.particleSystem.addParticles(
                  Math.random() * gameState.particleSystem.canvas.width,
                  Math.random() * gameState.particleSystem.canvas.height,
                  "#A78BFA",
                  3
                );
              }, i * 1000);
            }
          }
        }, 2000);

        // Add periodic ambient effects
        setInterval(() => {
          if (Math.random() < 0.3 && gameState.particleSystem) {
            gameState.particleSystem.addParticles(
              Math.random() * gameState.particleSystem.canvas.width,
              Math.random() * gameState.particleSystem.canvas.height,
              Math.random() > 0.5 ? "#A78BFA" : "#FBBF24",
              2
            );
          }
        }, 3000);
      }

      function checkAnswer(index, item, element, totalCheckpoints) {
        const checkBtn = element.querySelector(".check-btn");
        const answerInput = element.querySelector(".answer-input");
        const feedbackCorrect = element.querySelector(".feedback-correct");
        const feedbackIncorrect = element.querySelector(".feedback-incorrect");

        if (!answerInput || !feedbackCorrect || !feedbackIncorrect) return;

        feedbackCorrect.classList.add("hidden");
        feedbackIncorrect.classList.add("hidden");
        answerInput.classList.remove("border-red-500", "border-green-400");

        const userAnswer = parseInt(answerInput.value);

        if (userAnswer === item.answer) {
          feedbackCorrect.classList.remove("hidden");
          answerInput.classList.add("border-green-400");
          answerInput.disabled = true;
          if (checkBtn) checkBtn.disabled = true;
          element.classList.remove("active");

          // Add success particles
          if (gameState.particleSystem) {
            const rect = element.getBoundingClientRect();
            const containerRect = document
              .getElementById("particle-canvas")
              .getBoundingClientRect();
            gameState.particleSystem.addParticles(
              rect.left + rect.width / 2 - containerRect.left,
              rect.top + rect.height / 2 - containerRect.top,
              "#00FF00",
              15
            );
          }

          // Update progress
          gameState.checkpointsCompleted++;
          const percentage = Math.round(
            (gameState.checkpointsCompleted / totalCheckpoints) * 100
          );
          const progressBar = document.getElementById("progress-bar");
          if (progressBar) {
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `FUEL: ${percentage}%`;
          }

          // Unlock next part of the mission
          const nextPathIndex = index + 1;
          const nextCheckpointIndex = index + 2;

          if (gameState.checkpointElements[nextPathIndex]) {
            setTimeout(() => {
              gameState.checkpointElements[nextPathIndex].classList.add(
                "unlocked"
              );
              if (gameState.checkpointElements[nextCheckpointIndex]) {
                setTimeout(() => {
                  gameState.checkpointElements[
                    nextCheckpointIndex
                  ].classList.add("unlocked", "active");
                }, 400);
              }
            }, 200);
          } else {
            // This was the last checkpoint - start celebration!
            setTimeout(() => {
              const finalCongrats = document.getElementById("final-congrats");
              if (finalCongrats) {
                finalCongrats.classList.remove("hidden");
                const celebrationCanvas =
                  document.getElementById("celebration-canvas");
                if (celebrationCanvas) {
                  gameState.celebrationParticles = new CelebrationParticles(
                    celebrationCanvas
                  );
                }
              }
            }, 500);
          }
        } else {
          feedbackIncorrect.classList.remove("hidden");
          answerInput.classList.add("border-red-500");

          // Add error particles
          if (gameState.particleSystem) {
            const rect = element.getBoundingClientRect();
            const containerRect = document
              .getElementById("particle-canvas")
              .getBoundingClientRect();
            gameState.particleSystem.addParticles(
              rect.left + rect.width / 2 - containerRect.left,
              rect.top + rect.height / 2 - containerRect.top,
              "#FF0000",
              8
            );
          }
        }
      }

      function setupCertificate() {
        const getCertificateBtn = document.getElementById("get-certificate");
        const downloadCertificateBtn = document.getElementById(
          "download-certificate"
        );
        const restartMissionBtn = document.getElementById("restart-mission");

        if (getCertificateBtn) {
          getCertificateBtn.addEventListener("click", showCertificate);
        }

        if (downloadCertificateBtn) {
          downloadCertificateBtn.addEventListener("click", downloadCertificate);
        }

        if (restartMissionBtn) {
          restartMissionBtn.addEventListener("click", restartMission);
        }
      }

      function showCertificate() {
        const certificate = document.getElementById("certificate");
        const certificateName = document.getElementById("certificate-name");
        const certificateDate = document.getElementById("certificate-date");

        if (certificate && certificateName && certificateDate) {
          certificateName.textContent = gameState.playerName;
          certificateDate.textContent = new Date().toLocaleDateString("ar-EG", {
            year: "numeric",
            month: "long",
            day: "numeric",
          });

          certificate.classList.remove("hidden");
          certificate.scrollIntoView({ behavior: "smooth" });
        }
      }

      function downloadCertificate() {
        // --- هذا هو العنصر الذي يحتوي على الشهادة ---
        const certificateElement = document.getElementById("certificate");

        // --- هذا هو زر التحميل نفسه ---
        const downloadBtn = document.getElementById("download-certificate-btn");

        // --- التأكد من وجود العناصر قبل استخدامها ---
        if (!certificateElement || !downloadBtn) {
          console.error("عنصر الشهادة أو زر التحميل غير موجود.");
          return;
        }

        // إظهار رسالة للمستخدم بأن التحميل قيد الإعداد
        downloadBtn.textContent = "يتم إعداد الشهادة...";
        downloadBtn.disabled = true;

        // استخدام html2canvas لالتقاط صورة للشهادة
        html2canvas(certificateElement, {
          backgroundColor: "#f8f9fa", // تحديد لون خلفية ثابت للصورة
          scale: 2, // لزيادة جودة الصورة النهائية
        })
          .then((canvas) => {
            // إنشاء رابط مؤقت للتحميل
            const link = document.createElement("a");
            link.download = `شهادة-${gameState.playerName || "البطل"}.png`; // اسم الملف
            link.href = canvas.toDataURL("image/png");

            // تفعيل التحميل
            link.click();

            // إعادة الزر إلى حالته الطبيعية بعد فترة قصيرة
            setTimeout(() => {
              downloadBtn.textContent = "تحميل الشهادة 📥";
              downloadBtn.disabled = false;
            }, 1000);
          })
          .catch((err) => {
            // في حال حدوث خطأ أثناء التقاط الصورة
            console.error("خطأ في html2canvas:", err);
            downloadBtn.textContent = "حدث خطأ!";
            // لا تعيد تفعيل الزر فوراً لإعطاء المستخدم فرصة لرؤية الخطأ
          });
      }

      function restartMission() {
        // Reset game state
        gameState.checkpointsCompleted = 0;

        // Destroy celebration particles
        if (gameState.celebrationParticles) {
          gameState.celebrationParticles.destroy();
          gameState.celebrationParticles = null;
        }

        // Reset UI
        const nameForm = document.getElementById("name-form");
        const missionContent = document.getElementById("mission-content");
        const certificate = document.getElementById("certificate");
        const finalCongrats = document.getElementById("final-congrats");
        const progressBar = document.getElementById("progress-bar");
        const nameInput = document.getElementById("student-name");

        if (nameForm) nameForm.classList.remove("hidden");
        if (missionContent) missionContent.classList.add("hidden");
        if (certificate) certificate.classList.add("hidden");
        if (finalCongrats) finalCongrats.classList.add("hidden");
        if (nameInput) nameInput.value = "";

        if (progressBar) {
          progressBar.style.width = "0%";
          progressBar.textContent = "FUEL: 0%";
        }

        // Reset all checkpoints
        gameState.checkpointElements.forEach((element) => {
          element.classList.remove("unlocked", "active");

          const answerInput = element.querySelector(".answer-input");
          const checkBtn = element.querySelector(".check-btn");
          const feedbackCorrect = element.querySelector(".feedback-correct");
          const feedbackIncorrect = element.querySelector(
            ".feedback-incorrect"
          );

          if (answerInput) {
            answerInput.disabled = false;
            answerInput.value = "";
            answerInput.classList.remove("border-red-500", "border-green-400");
          }

          if (checkBtn) {
            checkBtn.disabled = false;
          }

          if (feedbackCorrect) {
            feedbackCorrect.classList.add("hidden");
          }

          if (feedbackIncorrect) {
            feedbackIncorrect.classList.add("hidden");
          }
        });
      }
    </script>
  </body>
</html>
